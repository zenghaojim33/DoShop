//
//  NewGoodViewController.m
//  DoShop
//
//  Created by Anson on 15/2/15.
//  Copyright (c) 2015年 Anson Tsang. All rights reserved.
//

#import "NewGoodViewController.h"
#import "NewGoodTableViewCell.h"
#import "SortGoodViewController.h"
@interface NewGoodViewController ()<UITableViewDataSource,UITableViewDelegate,GoodsButtonDelegate,SortGoodsDelegate>
@property (weak, nonatomic) IBOutlet UIButton *onSaleButton;
@property (weak, nonatomic) IBOutlet UITableView *productTableView;
@end
static NSString * cellIdentifier = @"NewGoodCell";
@implementation NewGoodViewController{
    
    
    NSMutableArray * _onSaleList;
    NSMutableArray * _productList;
    
    
}

- (void)viewDidLoad {
    [super viewDidLoad];
    // Do any additional setup after loading the view.
    
    self.productTableView.tableFooterView = [[UIView alloc]init];
    self.productTableView.separatorStyle = UITableViewCellSeparatorStyleNone;
    _productList = [[NSMutableArray alloc]init];
    _onSaleList = [[NSMutableArray alloc]init];
    NSString * userid = [[NSUserDefaults standardUserDefaults]objectForKey:@"userid"];
    
    
    [HTTPRequestManager getURL:[NSString stringWithFormat:@"http://dudian.beautyway.com.cn/json/client/product.ashx?aim=productlist&userid=%@&bos=&select=down&brand=&category=&key=&size=15&index=1",userid ] andParameter:nil onCompletion:^(NSDictionary *dict, NSError *error) {
        
        _productList = [dict[@"result"] copy];
        
        dispatch_async(dispatch_get_main_queue(), ^{
            [_productTableView reloadData];
        });
        
    }];
}

- (void)didReceiveMemoryWarning {
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}



#pragma mark ---------UITableViewDelegate--------



-(NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section

{
    return _productList.count;
}


-(UITableViewCell*)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath
{
    
    
    NewGoodTableViewCell * cell = [tableView dequeueReusableCellWithIdentifier:cellIdentifier];
    NSDictionary * infoDict = _productList[indexPath.row];
    
     NSString * imageUrl = [NSString stringWithFormat:@"%@%@",BASE_URL,infoDict[@"mainImgUrl"]];
    cell.goodName.text = infoDict[@"productName"];
    cell.productID = infoDict[@"id"];
   
    [cell.goodImageView sd_setImageWithURL:[NSURL URLWithString:imageUrl]];
    cell.productInfo.text = infoDict[@"size"];
    cell.delegate=self;
    
    
    //检查数组里是否存在这个cell对应的id，有的话就更改上架按钮的文字
    
    BOOL found = CFArrayContainsValue ( (__bridge CFArrayRef)_onSaleList,
                                        CFRangeMake(0, _onSaleList.count),
                                        (CFStringRef)cell.productID ) ;
    if (found)
    {
        cell.getOnSaleButton.selected = YES;
    }else{
        cell.getOnSaleButton.selected = NO;
    }
    
  
    
    return cell;
    
    
    
}




#pragma mark ------GoodsButtonDelegate----


-(void)putGoodsOnSale:(NSNumber *)productID
{
    
    if ([_onSaleList containsObject:productID])
    {
        [_onSaleList removeObject:productID];
    }else{
        [_onSaleList addObject:productID];
    }
    
    
    [self.onSaleButton setTitle:[NSString stringWithFormat:@"上架产品(%lu)",(unsigned long)_onSaleList.count] forState:UIControlStateNormal];
    
}


-(void)shareToSocialMedia
{
    
    
    
    
}



-(void)copyAddress
{
    
    
    
    
    
}



//点击上架商品
- (IBAction)contirmOnSale:(UIBarButtonItem*)sender {
    
    NSLog(@"%@",_onSaleList[0]);
    
    
    NSMutableString * firstProductID = [NSMutableString stringWithFormat:@"%@",_onSaleList[0]];

    [_onSaleList enumerateObjectsUsingBlock:^(NSString * productID, NSUInteger idx, BOOL *stop) {
        if (idx>0)
        {
            [firstProductID appendFormat:@",%@",productID];
        }
    }];
    
    
    
    NSLog(@"%@",firstProductID);
    NSNumber * userid = [[NSUserDefaults standardUserDefaults]objectForKey:@"userid"];
    NSDictionary * postDict = @{@"userid":userid,
                                @"productid":firstProductID,
                                @"type":@"add",
                                };
    [HTTPRequestManager postURL:CONFIRM_ON_SALE_API andParameter:postDict onCompletion:^(NSDictionary *dict, NSError *error) {
        
    }];
    
    
    
}

-(void)prepareForSegue:(UIStoryboardSegue *)segue sender:(id)sender
{
    if ([segue.identifier isEqualToString:@"Sort"])
    {
        SortGoodViewController * vc = segue.destinationViewController;
        vc.delegate=self;
    }
}


#pragma mark -----SortGoodsDelegate-----

-(void)sortGoodsWithCategory:(NSString *)category andSupplier:(NSString *)supplier
{
    
   
    
    
}




/*
#pragma mark - Navigation

// In a storyboard-based application, you will often want to do a little preparation before navigation
- (void)prepareForSegue:(UIStoryboardSegue *)segue sender:(id)sender {
    // Get the new view controller using [segue destinationViewController].
    // Pass the selected object to the new view controller.
}
*/

@end
