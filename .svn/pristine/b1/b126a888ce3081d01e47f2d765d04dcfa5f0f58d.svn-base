//
//  MyIncomeViewController.m
//  DoShop
//
//  Created by Anson on 15/2/13.
//  Copyright (c) 2015年 Anson Tsang. All rights reserved.
//

#import "MyIncomeViewController.h"
#import "MyIncomeTableViewCell.h"
#import "GetIncomeViewController.h"
#import "ChangInfoViewController.h"
#import "UICountingLabel.h"
#import "CustomTitleLabelTableView.h"
#import <MJRefresh.h>
#import "DSIncome_IncomeModel.h"
#import "DSIncome_RecordModel.h"
typedef NS_ENUM(NSInteger, SelectedTable){
    
    MyIncomeSelected = 1,
    MyBalanceSelected,
    AllIncomeSelected
};


@interface MyIncomeViewController ()<UITableViewDataSource,UITableViewDelegate>




@property (weak, nonatomic) IBOutlet CustomTitleLabelTableView  *myIncomeTableview;
@property (weak, nonatomic) IBOutlet UIButton *myIncomeBtn;
@property (weak, nonatomic) IBOutlet UICountingLabel *myBalanceLabel;
@property (weak, nonatomic) IBOutlet UIButton *myStoreBtn;
@property (weak, nonatomic) IBOutlet UIButton *allIncomeBtn;
@property (nonatomic)NSInteger type;

@end

static  NSString * MyStoreIncome = @"StoreIncomeCell";
static  NSString * MyIncome = @"MyIncomeCell";

@implementation MyIncomeViewController{
    
    DSIncome_IncomeModel * _model;
    UIColor * _originalbtncolor;
    NSMutableArray * _myIncomeArray;
    NSMutableArray * _myBalanceArray;
    NSMutableArray * _allIncomeArray;
    NSMutableArray * _currentArray;
    NSInteger page;
    NSString * _userid;
    
}

- (void)viewDidLoad {
    [super viewDidLoad];
    // Do any additional setup after loading the view.
    self.title = @"我的财富";
    self.myIncomeTableview.tableFooterView = [[UIView alloc]init];
    _originalbtncolor = self.myIncomeBtn.backgroundColor;
    [self.myIncomeTableview addHeaderWithTarget:self action:@selector(headerRefresh)];
    [self.myIncomeTableview addFooterWithTarget:self action:@selector(footerRefresh)];
    page=1;  //初始化第一页
    
    _userid = [[NSUserDefaults standardUserDefaults]objectForKey:@"userid"];
    
    _myBalanceArray = [[NSMutableArray alloc]init];
    _myIncomeArray = [[NSMutableArray alloc]init];
    _allIncomeArray = [[NSMutableArray alloc]init];
    self.type = MyIncomeSelected;
    [HTTPRequestManager getURL:[NSString stringWithFormat:GET_INCOME_API,_userid,self.type,page] andParameter:nil onCompletion:^(NSDictionary *dict, NSError *error) {
        
        
        _model = [DSIncome_IncomeModel init:dict[@"result"]];
        
        
        
        _myIncomeArray  =[dict[@"result"][@"records"] mutableCopy];
        _currentArray = _myIncomeArray;
        NSNumber * myBalance = dict[@"result"][@"cashBalance"];
        dispatch_async(dispatch_get_main_queue(), ^{
           
            _myBalanceLabel.method = UILabelCountingMethodEaseOut;
            _myBalanceLabel.format = @"%.1f";
            [_myBalanceLabel countFrom:0 to:myBalance.floatValue withDuration:1.5];
            
            
            
            [self.myIncomeTableview reloadData];
            
        });
        
    }];
    
}








- (void)didReceiveMemoryWarning {
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}


#pragma mark --------输入收款账户---------

//- (IBAction)enterMyAccount:(id)sender {
//    
//    ChangInfoViewController * vc = [[ChangInfoViewController alloc]init];
//    vc.isChange=YES;
//    [self.navigationController pushViewController:vc animated:YES];
//    
//
//}


#pragma mark ------申请提现---------

- (IBAction)applyForBalance:(id)sender {
    
    
    
    GetIncomeViewController * vc = [self.storyboard instantiateViewControllerWithIdentifier:@"GetIncomeViewController"];
    [self.navigationController pushViewController:vc animated:YES];
    
    
    
    
}





#pragma mark --------我的收入---------

- (IBAction)myIncome:(id)sender {
    
    
    self.myIncomeBtn.backgroundColor = [UIColor colorWithRed:0.737 green:0.176 blue:0.196 alpha:1.000];
    
    self.myIncomeBtn.tintColor = [UIColor whiteColor];
    self.myStoreBtn.backgroundColor = [UIColor whiteColor];
    self.myStoreBtn.tintColor = [UIColor blackColor];
    self.allIncomeBtn.backgroundColor = [UIColor whiteColor];
    self.allIncomeBtn.tintColor = [UIColor blackColor];
    self.type = MyIncomeSelected;
    
    
    [HTTPRequestManager getURL:[NSString stringWithFormat:GET_INCOME_API,_userid,self.type,page]  andParameter:nil onCompletion:^(NSDictionary *dict, NSError *error) {
        _model = [DSIncome_IncomeModel init:dict[@"result"]];
        
        _myIncomeArray = [dict[@"result"][@"records"]mutableCopy];
        
        _currentArray = _myIncomeArray;
        dispatch_async(dispatch_get_main_queue(), ^{
            [_myIncomeTableview reloadData];
        });
        
    }];
    
    
    

    
    
}


#pragma mark --------提现详情---------


- (IBAction)myStore:(id)sender {
    
    self.myStoreBtn.backgroundColor = [UIColor colorWithRed:0.737 green:0.176 blue:0.196 alpha:1.000];
    self.myStoreBtn.tintColor = [UIColor whiteColor];
    self.myIncomeBtn.backgroundColor = [UIColor whiteColor];
    self.myIncomeBtn.tintColor = [UIColor blackColor];
    self.allIncomeBtn.backgroundColor = [UIColor whiteColor];
    self.allIncomeBtn.tintColor = [UIColor blackColor];
    self.type = MyBalanceSelected;
    
    
    [HTTPRequestManager getURL:[NSString stringWithFormat:GET_INCOME_API,_userid,self.type,page] andParameter:nil onCompletion:^(NSDictionary *dict, NSError *error) {
        
        _model = [DSIncome_IncomeModel init:dict[@"result"]];

        _myBalanceArray = [dict[@"result"][@"records"]mutableCopy];
        _currentArray = _myBalanceArray;
        dispatch_async(dispatch_get_main_queue(), ^{
            [_myIncomeTableview reloadData];
        });
        
    }];
    
    

}

- (IBAction)allIncome:(id)sender {
    
    
    self.allIncomeBtn.backgroundColor = [UIColor colorWithRed:0.737 green:0.176 blue:0.196 alpha:1.000];
    
    self.allIncomeBtn.tintColor = [UIColor whiteColor];
    self.myStoreBtn.backgroundColor = [UIColor whiteColor];
    self.myStoreBtn.tintColor = [UIColor blackColor];
    self.myIncomeBtn.backgroundColor = [UIColor whiteColor];
    self.myIncomeBtn.tintColor = [UIColor blackColor];
    self.type = AllIncomeSelected;
    
    [HTTPRequestManager getURL:[NSString stringWithFormat:GET_INCOME_API,_userid,self.type,page]  andParameter:nil onCompletion:^(NSDictionary *dict, NSError *error) {
        
        _model = [DSIncome_IncomeModel init:dict[@"result"]];

        _allIncomeArray = [dict[@"result"][@"records"]mutableCopy];
        _currentArray = _allIncomeArray;
        dispatch_async(dispatch_get_main_queue(), ^{
            [_myIncomeTableview reloadData];
        });
        
    }];
    
    
    
}


#pragma mark -------UITableViewDelegate-------



-(UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath
{
    
    MyIncomeTableViewCell * cell = [tableView dequeueReusableCellWithIdentifier:MyStoreIncome];
    
    
    NSMutableArray * currentArray;
    if (self.type==MyIncomeSelected)
    {
        currentArray = _myIncomeArray;
    }else if (self.type == MyBalanceSelected){
        
        currentArray = _myBalanceArray;
    }else if (self.type == AllIncomeSelected){
        currentArray = _allIncomeArray;
    }
    
    
    DSIncome_RecordModel * recordModel = _model.records[indexPath.row];
    
    [cell updateCellWithModel:recordModel];

    
    
    return cell;
    
    
}


-(NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section
{

    return _model.records.count;
    
    
}


#pragma mark ----MJRefresh------
-(void)headerRefresh
{
    
    page=1;

    [HTTPRequestManager getURL:[NSString stringWithFormat:GET_INCOME_API,_userid,self.type,page]  andParameter:nil onCompletion:^(NSDictionary *dict, NSError *error) {
    
        _model = [DSIncome_IncomeModel init:dict[@"result"]];

 
        dispatch_async(dispatch_get_main_queue(), ^{
            [_myIncomeTableview reloadData];
            [_myIncomeTableview headerEndRefreshing];
        });
        
    }];
    
    
}




-(void)footerRefresh
{
    
    
    page++;
    

    [HTTPRequestManager getURL:[NSString stringWithFormat:GET_INCOME_API,_userid,self.type,page]  andParameter:nil onCompletion:^(NSDictionary *dict, NSError *error) {
        
        DSIncome_IncomeModel * newModel = [DSIncome_IncomeModel init:dict[@"result"]];
        
        if (_model.records.count>0)
        {
            [_model.records addObjectsFromArray:newModel.records];
        }

        
        dispatch_async(dispatch_get_main_queue(), ^{
            [_myIncomeTableview reloadData];
            [_myIncomeTableview footerEndRefreshing];
        });
        
    }];
    

    
}




/*
#pragma mark - Navigation

// In a storyboard-based application, you will often want to do a little preparation before navigation
- (void)prepareForSegue:(UIStoryboardSegue *)segue sender:(id)sender {
    // Get the new view controller using [segue destinationViewController].
    // Pass the selected object to the new view controller.
}
*/

@end
