//
//  MyIncomeViewController.m
//  DoShop
//
//  Created by Anson on 15/2/13.
//  Copyright (c) 2015年 Anson Tsang. All rights reserved.
//

#import "MyIncomeViewController.h"
#import "MyIncomeTableViewCell.h"
#import "GetIncomeViewController.h"
#import "ChangInfoViewController.h"
#import <MJRefresh.h>
typedef NS_ENUM(NSInteger, SelectedTable){
    
    MyIncomeSelected = 1,
    MyBalanceSelected,
   
};


@interface MyIncomeViewController ()<UITableViewDataSource,UITableViewDelegate>




@property (weak, nonatomic) IBOutlet UILabel *myIncomeLabel;
@property (weak, nonatomic) IBOutlet UITableView *myIncomeTableview;
@property (weak, nonatomic) IBOutlet UIButton *myIncomeBtn;
@property (weak, nonatomic) IBOutlet UILabel *myBalanceLabel;
@property (weak, nonatomic) IBOutlet UIButton *myStoreBtn;
@property (nonatomic)NSInteger type;

@end

static  NSString * MyStoreIncome = @"StoreIncomeCell";
static  NSString * MyIncome = @"MyIncomeCell";

@implementation MyIncomeViewController{
    
    
    UIColor * _originalbtncolor;
    NSMutableArray * _myIncomeArray;
    NSMutableArray * _myBalanceArray;
    NSMutableArray * _currentArray;
    NSInteger page;
    
    
}

- (void)viewDidLoad {
    [super viewDidLoad];
    // Do any additional setup after loading the view.
    self.title = @"我的财富";
    self.myIncomeTableview.tableFooterView = [[UIView alloc]init];
    _originalbtncolor = self.myIncomeBtn.backgroundColor;
    [self.myIncomeTableview addHeaderWithTarget:self action:@selector(headerRefresh)];
    [self.myIncomeTableview addFooterWithTarget:self action:@selector(footerRefresh)];
    page=1;  //初始化第一页
    
    
    
    _myBalanceArray = [[NSMutableArray alloc]init];
    _myIncomeArray = [[NSMutableArray alloc]init];
    self.type = MyIncomeSelected;
    [HTTPRequestManager getURL:GET_INCOME_API andParameter:nil onCompletion:^(NSDictionary *dict, NSError *error) {
        
        
        _myIncomeArray  =[dict[@"result"][@"records"] mutableCopy];
        _currentArray = _myIncomeArray;
        NSNumber * myincome = dict[@"result"][@"sum"];
        NSNumber * myBalance = dict[@"result"][@"cashBalance"];
        dispatch_async(dispatch_get_main_queue(), ^{
           
            _myIncomeLabel.text = [NSString stringWithFormat:@"￥%@",myincome];
            _myBalanceLabel.text = [NSString  stringWithFormat:@"￥%@",myBalance];
            [self.myIncomeTableview reloadData];
            
        });
        
    }];
    
}








- (void)didReceiveMemoryWarning {
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}


#pragma mark --------输入收款账户---------

- (IBAction)enterMyAccount:(id)sender {
    
    ChangInfoViewController * vc = [[ChangInfoViewController alloc]init];
    vc.isChange=YES;
    [self.navigationController pushViewController:vc animated:YES];
    
    
}


#pragma mark ------申请提现---------

- (IBAction)applyForBalance:(id)sender {
    
    
    
    GetIncomeViewController * vc = [self.storyboard instantiateViewControllerWithIdentifier:@"GetIncomeViewController"];
    [self.navigationController pushViewController:vc animated:YES];
    
    
    
    
}





#pragma mark --------我的收入---------

- (IBAction)myIncome:(id)sender {
    
    
    self.myIncomeBtn.backgroundColor = [UIColor colorWithRed:0.737 green:0.176 blue:0.196 alpha:1.000];
    
    self.myIncomeBtn.tintColor = [UIColor whiteColor];
    self.myStoreBtn.backgroundColor = [UIColor whiteColor];
    self.myStoreBtn.tintColor = [UIColor blackColor];
    self.type = MyIncomeSelected;
    
    
    [HTTPRequestManager getURL:GET_INCOME_API andParameter:nil onCompletion:^(NSDictionary *dict, NSError *error) {
        
        
        _myIncomeArray = [dict[@"result"][@"records"] mutableCopy];
        _currentArray = _myIncomeArray;
        dispatch_async(dispatch_get_main_queue(), ^{
            [_myIncomeTableview reloadData];
        });
        
    }];
    
    
    
    [self.myIncomeTableview reloadData];

    
    
}


#pragma mark --------提现详情---------


- (IBAction)myStore:(id)sender {
    
    self.myStoreBtn.backgroundColor = [UIColor colorWithRed:0.737 green:0.176 blue:0.196 alpha:1.000];
    self.myStoreBtn.tintColor = [UIColor whiteColor];
    self.myIncomeBtn.backgroundColor = [UIColor whiteColor];
    self.myIncomeBtn.tintColor = [UIColor blackColor];
    self.type = MyBalanceSelected;
    
    
    [HTTPRequestManager getURL:GET_SPENDING_API andParameter:nil onCompletion:^(NSDictionary *dict, NSError *error) {
        
        
        _myBalanceArray = [dict[@"result"][@"records"]mutableCopy];
        _currentArray = _myBalanceArray;
        dispatch_async(dispatch_get_main_queue(), ^{
            [_myIncomeTableview reloadData];
        });
        
    }];
    
    

}


#pragma mark -------UITableViewDelegate-------



-(UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath
{
    
    MyIncomeTableViewCell * cell = [tableView dequeueReusableCellWithIdentifier:MyStoreIncome];
    
    
    NSMutableArray * currentArray;
    if (self.type==MyIncomeSelected)
    {
        currentArray = _myIncomeArray;
    }else{
        
        currentArray = _myBalanceArray;
    }
    
    
    NSDictionary * infoDict = currentArray[indexPath.row];
    
    cell.timeLabel.text = infoDict[@"time"];
    NSNumber * income = infoDict[@"money"];
    cell.incomeLabel.text = [NSString stringWithFormat:@"￥%@",income];
    
    
    
    return cell;
    
    
}


-(NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section
{

    return _currentArray.count;
    
    
}


#pragma mark ----MJRefresh------
-(void)headerRefresh
{
    
    page=1;
    NSString * API;
    if (self.type==MyBalanceSelected)
    {
        API = GET_SPENDING_API;
    }else{
        API = GET_INCOME_API;
    }
    [HTTPRequestManager getURL:API andParameter:nil onCompletion:^(NSDictionary *dict, NSError *error) {
    
        if (_currentArray)
        {
            [_currentArray removeAllObjects];
            [_currentArray addObjectsFromArray:dict[@"result"][@"records"]];
        }
        
        dispatch_async(dispatch_get_main_queue(), ^{
            [_myIncomeTableview reloadData];
            [_myIncomeTableview headerEndRefreshing];
        });
        
    }];
    
    
}




-(void)footerRefresh
{
    
    
    page++;
    
    NSString * API;
    if (self.type==MyBalanceSelected)
    {
        API = GET_SPENDING_API;
    }else{
        API = GET_INCOME_API;
    }
    [HTTPRequestManager getURL:API andParameter:nil onCompletion:^(NSDictionary *dict, NSError *error) {
        
        if (_currentArray)
        {
            [_currentArray removeAllObjects];
            [_currentArray addObjectsFromArray:dict[@"result"][@"records"]];
        }
        
        dispatch_async(dispatch_get_main_queue(), ^{
            [_myIncomeTableview reloadData];
            [_myIncomeTableview footerEndRefreshing];
        });
        
    }];
    
}




/*
#pragma mark - Navigation

// In a storyboard-based application, you will often want to do a little preparation before navigation
- (void)prepareForSegue:(UIStoryboardSegue *)segue sender:(id)sender {
    // Get the new view controller using [segue destinationViewController].
    // Pass the selected object to the new view controller.
}
*/

@end
